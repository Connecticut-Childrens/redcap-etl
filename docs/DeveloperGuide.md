REDCap-ETL Developer Guide
======================================

Development Environment Setup
-------------------------------------

This is a list of the steps for setting up a REDCap-ETL development environment. Example commands are shown for Ubuntu 16.

1. Install PHP

        sudo apt install php php-curl php-mbstring php-mysql php-xml
        sudo phpenmod mysqli   # enable mysqli extension
        sudo phpenmod pdo_mysql # enable PDO extension for PHP 
        sudo apt install php-xdebug  # Install XDebug to be able to see phpunit test code coverage

2. Install Composer (needed to get PHPCap and development dependencies)

        sudo apt install composer

3. Install sendmail (needed for logging to e-mail)

        sudo apt install sendmail
        
    Note: after REDCap-ETL has been installed, its **bin/email_test.php** script can be used to test if e-mail logging
works.

4. Install MySQL

        sudo apt install mysql-server
        sudo mysql_secure_installation
        systemctl status mysql.service   # check status

5. Create a database and database user that will be used as the place to store the REDCap data, for example, in MySQL use:

        CREATE DATABASE `etl_test`;
        CREATE USER 'etl_user'@'localhost' IDENTIFIED BY 'etlPassword';
        GRANT ALL ON `etl_test`.* TO 'etl_user'@'localhost';

6. Install Apache (used for DET (Data Entry Trigger) web scripts)

        sudo apt install apache2 libapache2-mod-php

7. Install Git

        sudo apt install git
        # Add e-mail and name information, for example:
        git config --global user.email "jsmith@someuniversity.edu"
        git config --global user.name "J Smith"

8. Get the code. Execute the following command in the directory where
   you want to put REDCap-ETL:

        git clone https://github.com/IUREDCap/redcap-etl

9. Install Composer dependencies. In the top-level directory where the code was downloaded, run:

        composer install

### REDCap-ETL Directory Structure

After the steps above have been successfully completed,
the REDCap-ETL software directory should have a structure similar to
what is listed below. The main directories and files are as follows:

* __bin/__ - directory containing scripts
* __config/__ - default configuration directory for REDCap-ETL
* __dependencies/__ - static dependencies used for production installation
* __docs/__ - documentation
* __projects/__ - REDCap-ETL project templates for configuration and logging
* __src/__ - the REDCap-ETL source code directory
* __tests/__ - automated tests directory
    * __config/__ - directory for test configuration files that have been
    customized for your system
    * __config-init/__ - initial test configuration files for copying and
    then customizing for your specific installation
    * __coverage/__ - directory set up for storing testing code coverage
    reports, where files are ignored by Git
    * __data/__ - test result comparison data
    * __integration/__ - code for integration tests
    * __logs/__ - test log files (ignored by Git)
    * __output/__ - test generate output files (ignored by Git)
    * __projects/__ - test REDCap projects
    * __system/__ - code for system tests
    * __unit/__ - code for unit tests 
* __vendor/__ - directory where the dependencies generated by Composer
are installed
* _composer.json_ - JSON configuration file for Composer
* _phpunit.xml_ - configuration file for automated tests run with PHPUnit 
* _README.md_ - main README file for REDCap-ETL





Automated Tests
------------------------------

There are 3 types of automated tests:

1. __Unit__ - each test focuses on a single class
2. __Integration__ - tests focus on the integration of multiple classes
3. __System__ - tests focus on testing the system as a whole (multiple classes + scripts)

The test types above are listed in order of least to most setup effort.

|                                       | Unit |Integration | System    |
|---------------------------------------|------|:----------:|:---------:|
| __Configuration file setup required__ |      | &#10003;   | &#10003;  |
| __REDCap project setup required__     |      | &#10003;   | &#10003;  |
| __MySQL database setup required__     |      |            | &#10003;  |
| __Web server setup required__         |      |            | &#10003;  |
| __Webs script setup required__        |      |            | &#10003;  |



### Unit Tests
You should be able to run the unit tests at this point if you have
completed the previous steps.
To run the unit tests, enter the following in a command shell
at the top-level directory of the REDCap-ETL installation:

    ./vendor/bin/phpunit --testsuite unit
    
If this command runs successfully, you should see an "OK" message that
indicates the number of tests and assertions that were successful.

### Integration and System Tests
Setting up the integration and system tests requires having access
to a REDCap instance, and the ability to get API tokens for projects
on that instance. Setting these tests up is not required, but
the tests have much better code coverage when they are.

#### Integration tests
To set up the integration tests, you need to first set up
the Basic Demography REDCap project that has the data for the
tests:

1. In REDCap, create one project using the
   "Upload a REDCap project XML file" option, for each of the
   following files from REDCap-ETL:

        tests/projects/BasicDemography.REDCap.xml
        tests/projects/RepeatingEvents.REDCap.xml

2. Request API tokens for the projects you just created (or
   create tokens if you are an admin). The tokens needs to have export
   permission.

The next thing you need to do is to create the configuration files
for the tests:

1. Copy the configuration and transformation rules
   files from the tests/config-init directory to the tests/config
   directory. From the top-level directory:
   
        cp tests/config-init/basic-demography.ini tests/config
        cp tests/config-init/basic-demography-rules.txt tests/config
        cp tests/config-init/basic-demography.json tests/config
        cp tests/config-init/basic-demography-2.ini tests/config
        cp tests/config-init/repeating-events.ini tests/config
        cp tests/config-init/repeating-events-rules.txt tests/config

2. Edit the .ini and .json files that were copied to the tests/config/
   directory, and set the 
   following properties to appropriate values:
   
    1. __redcap_api_url__ - set this to the URL for your REDCap's API. Be
       sure to set this to the URL for the _API_, which typically ends
       with "/api/".

    2. __data_source_api_token__ - set this to the REDCap API token for
       your REDCap Basic Demography project created above.

After the above steps have been completed successfully, you should be
able to run the integration tests by executing the following command
in the top-level directory of your REDCap-ETL installation:

    ./vendor/bin/phpunit --testsuite integration


#### System tests
To set up the system steps:

1. In REDCap, create a project using the
   "Upload a REDCap project XML file" option for each of the following
   REDCap project files:

        tests/projects/Visits.REDCap.xml
        tests/projects/VisitsConfig.REDCap.xml
        tests/projects/VisitsLog.REDCap.xml

2. Request an API token for each of the projects you just created (or
   create a token if you are an admin). The configuration and logging
   project tokens need to have export and "API Import/Update"
   permissions. The data project API token needs to have 
   "API Export" permission.

In the configuration project (created from the VisitsConfig.REDCap.xml
file):

1. Set the log project api token in the Admin form of the existing
   record to the token that you got for the log project
   (created using file VisitsLog.REDCap.xml).

2. Set the data source API token in the ETL Process
   form to the value of the API token you got for the
   data project (created from file Visits.REDCap.xml).

3, If you used a different username, password, or database name
   than those used in the example above for the MySQL database,
   change the values appropriately in the database connection string
   field. The syntax to use is:

        MySQL:<db-host>:<db-username>:<db-password>:<db-name>


The next thing you need to do is to create the configuration file
for the Visits project:

1. Copy the visits configuration and SQL post-processing files from the 
   tests/config-init directory to the tests/config
   directory, for example, from the top-level directory:
   
        cp tests/config-init/visits.ini tests/config
        cp tests/config-init/visits.sql tests/config

2. Edit the file tests/config/visits.ini and set the 
   following properties to appropriate values:
   
    1. __redcap_api_url__ - set this to the URL for your REDCap's API. Be
       sure to set this to the URL for the _API_, which typically ends
       with "/api/".

    2. __config_api_token__ - set this to the REDCap API token for
       your REDCap Visits Config project created above.

You can check the setup so far by running the following command in the
top-level directory of you REDCap-ETL installation:

        ./bin/project_info.php tests/config/visits.ini 
    
If things have been set up correctly, you should see the correct
project names displayed for the configuration, data and logging
projects.

You can also check the configuration for errors with the following
command:

        ./bin/config_check.php tests/config/visits.ini 

You now need to run the web script installation script to install a
web script that will handle DETs (Data Entry Triggers) from REDCap.
The DET will be simulated, so you won't actually need to set this
up in your REDCap configuration project as you normally would in
a production installation.

To install the web script, from the top-level directory of your
REDCap-ETL installation, run the install_web_scripts.php
script, for example:

        ./bin/install_web_scripts.php -c tests/config -w /var/www/html

Notes:

* You may need to run the command as: 
  `php ./bin/install_web_script.php ...`
* `/var/www/html` represents the directory from which your web server
  serves pages. Change this if your actual directory is different.
* Make sure that the `web_script_url` property in the 
  tests/config/visits.ini configuration file is set to a value
  that corresponds to the directory where the web script is installed 
* The owner of your web server process must be able to read from
  your REDCap-ETL installation directory.
* If you don't have permission to write to the web directory, you
  may need to run the command as
  
      `sudo ./bin/install_web_scripts.php ...`

After the above steps have been completed successfully, you should be
able to run the system tests by executing the following command
in the top-level directory of your REDCap-ETL installation:

    ./vendor/bin/phpunit --testsuite system


### Running the Tests

To run all of the automated test, in the top-level directory run:

    ./vendor/bin/phpunit

The system tests use the REDCap-ETL scripts, so the DET web script
will need to be set up.


#### Generating test coverage

To see test coverage information, you need to have XDebug installed, and
then run the following command from the root directory of the project:

    ./vendor/bin/phpunit --coverage-html tests/coverage

Then with a browser, open the file:

    tests/coverage/index.html

The output
could be stored in a different directory, but directory tests/coverage
has been set up to be ignored by Git.

API Documentation
-----------------------------------

The API documentation is programmatically generated and is not stored
in GitHub.

To generate the API documentation, execute the following command in the
top-level REDCap-ETL directory:

    ./vendor/bin/apigen generate
    
To view the API documentation, open the following file with a web browser:

    ./docs/api/index.html

Note that the version of apigen used does not appear to work 
with PHP 7.2.


Coding Standards Compliance
------------------------------------

REDCap-ETL follows these PHP coding standards:

* [PSR-1: Basic Coding Standard](http://www.php-fig.org/psr/psr-1/)
* [PSR-2: Coding Style Guide](http://www.php-fig.org/psr/psr-2/)
* [PSR-4: Autoloader](http://www.php-fig.org/psr/psr-4/)
* Lower camel case variable names, e.g., $primaryKey

From the top-level directory of your REDCap-ETL installation,
the following command can be used
to check for coding standards compliance:

    ./vendor/bin/phpcs

The coding standards checks that are done (by default) are configured in the file __phpcs.xml__ in the top-level directory.
